<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Course Dependency Graph</title>
    <link rel="stylesheet" href="css/main_style.css" type="text/css" />
    <script
      language="javascript"
      type="text/javascript"
      src="js/jquery.min.js"
      defer
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="js/arbor.js"
      defer
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="js/arbor-tween.js"
      defer
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="js/renderer.js"
      defer
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="js/graphics.js"
      defer
    ></script>
    <script
      language="javascript"
      type="text/javascript"
      src="js/courseDependencyGraph.js"
      defer
    ></script>
  </head>

  <body>
    <!-- Modern single-row header -->
    <header id="appHeader" role="banner">
      <div class="brand">
        <h1>Course Dependency Graph</h1>
        <span class="brand-accent" aria-hidden="true">•</span>
        <span class="brand-sub">interactive</span>
      </div>

      <div class="controls" role="region" aria-label="Controls">
        <label for="academicMajor" class="visually-hidden">Select Major</label>
        <select id="academicMajor" class="control-select">
          <option value="json/chemistry.json">Chemistry</option>
          <option selected="selected" value="json/computerscience.json">
            Computer Science
          </option>
          <option value="json/economics.json">Economics</option>
          <option value="json/mathematics.json">Mathematics</option>
          <option value="json/psychology.json">Psychology</option>
        </select>
        <a id="displayEntireDependencyGraph" href="#" class="control-btn"
          >Display Full Graph</a
        >
        <a id="clearGraph" href="#" class="control-btn">Reset Graph</a>
      </div>
    </header>

    <div id="container">
      <canvas id="viewport"></canvas>
      <button id="sidePanelToggle" aria-label="Toggle Side Panel">
        <img
          src="svg/sidebar-right.svg"
          alt="Right Sidebar"
          width="25"
          height="20"
        />
      </button>
      <div id="sidePanel">
        <div
          class="sidepanel-header"
          role="banner"
          aria-label="Courses panel header"
        >
          <h2 class="sidepanel-title">Courses</h2>
          <button
            id="sidePanelClose"
            class="sidepanel-close"
            type="button"
            aria-label="Close side panel"
            title="Close"
          >
            ✕
          </button>
        </div>

        <div class="sidepanel-content" role="region" aria-label="Courses list">
          <!-- Completed courses section -->
          <section id="completedCourses" class="completed-list">
            <h3 class="panel-subtitle">Completed</h3>
            <div id="completedList"></div>
          </section>

          <!-- Remaining courses section -->
          <section id="remainingCourses" class="remaining-list">
            <h3 class="panel-subtitle">Available</h3>
            <div id="courseButtons"></div>
          </section>
        </div>
      </div>

      <!-- Legend placed over bottom-left of the canvas (shows by default) -->
      <aside
        id="legend"
        class="legend-visible"
        aria-label="Legend"
        aria-hidden="false"
      >
        <button
          id="legendToggle"
          class="legend-toggle"
          aria-pressed="false"
          title="Hide legend"
        >
          ✕
        </button>
        <h3>Legend</h3>
        <ul>
          <li>
            <span class="legend-box grey" aria-hidden="true"></span>Unavailable
          </li>
          <li>
            <span class="legend-box blue" aria-hidden="true"></span>Ready to
            Take
          </li>
          <li>
            <span class="legend-box green" aria-hidden="true"></span>Complete
          </li>
        </ul>
      </aside>

      <!-- small legend-open button (svg legend icon) shown only when legend is hidden -->
      <button
        id="legendOpen"
        class="legend-open"
        aria-hidden="true"
        title="Show legend"
        aria-label="Show legend"
      >
        <svg
          width="20"
          height="20"
          viewBox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          focusable="false"
        >
          <!-- three colored dots and lines representing legend items -->
          <circle cx="3.5" cy="4.5" r="1.2" fill="#bdbdbd" />
          <rect
            x="6.5"
            y="3.6"
            width="10"
            height="1.8"
            rx="0.9"
            fill="#eef2ff"
          />

          <circle cx="3.5" cy="9.5" r="1.2" fill="#2563eb" />
          <rect
            x="6.5"
            y="8.6"
            width="10"
            height="1.8"
            rx="0.9"
            fill="#eef2ff"
          />

          <circle cx="3.5" cy="14.5" r="1.2" fill="#16a34a" />
          <rect
            x="6.5"
            y="13.6"
            width="10"
            height="1.8"
            rx="0.9"
            fill="#eef2ff"
          />
        </svg>
      </button>
    </div>

    <!-- script moved inside body bottom; fixes initial visibility and avoids duplicates -->
    <script>
      (function () {
        // legend toggle: show/hide and persist preference
        const LEGEND_KEY = "cdg.legendHidden";

        // single legend inside #container
        const legend = document.querySelector("#container > #legend");
        const closeBtn = document.getElementById("legendToggle");
        const openBtn = document.getElementById("legendOpen");

        if (!legend || !closeBtn || !openBtn) return;

        function setLegendHidden(hidden, persist = true) {
          if (hidden) {
            legend.classList.remove("legend-visible");
            legend.classList.add("legend-hidden");
            legend.setAttribute("aria-hidden", "true");
            closeBtn.setAttribute("aria-pressed", "true");
            closeBtn.title = "Show legend";
            // hide the close button and show the open button
            closeBtn.style.display = "none";
            openBtn.style.display = "inline-flex";
            openBtn.setAttribute("aria-hidden", "false");
          } else {
            legend.classList.remove("legend-hidden");
            legend.classList.add("legend-visible");
            legend.setAttribute("aria-hidden", "false");
            closeBtn.setAttribute("aria-pressed", "false");
            closeBtn.title = "Hide legend";
            // show the close button and hide the open button
            closeBtn.style.display = "inline-flex";
            openBtn.style.display = "none";
            openBtn.setAttribute("aria-hidden", "true");
          }
          if (persist) {
            localStorage.setItem(LEGEND_KEY, hidden ? "true" : "false");
          }
        }

        // initialize from storage (default: visible)
        const stored = localStorage.getItem(LEGEND_KEY);
        const startHidden = stored === "true";

        // ensure DOM default display states before applying persisted state
        closeBtn.style.display = "inline-flex";
        openBtn.style.display = "none";
        openBtn.setAttribute("aria-hidden", "true");

        setLegendHidden(startHidden, false);

        // close inside legend
        closeBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          setLegendHidden(true);
        });

        // open via help button
        openBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          setLegendHidden(false);
        });

        // ----------------------------------------------------------
        // NEW: prepend academicMajor text to side panel heading
        // ----------------------------------------------------------
        const majorSelect = document.getElementById("academicMajor");
        const sideTitle = document.querySelector("#sidePanel .sidepanel-title");
        function updateSidepanelTitle() {
          if (!sideTitle || !majorSelect) return;
          const idx = majorSelect.selectedIndex;
          const majorText =
            (majorSelect.options &&
              majorSelect.options[idx] &&
              majorSelect.options[idx].text) ||
            majorSelect.value ||
            "";
          // prepend major text to the heading (e.g. "Computer Science — Courses")
          sideTitle.textContent = majorText + " Courses";
        }

        // set initial title and listen for changes
        updateSidepanelTitle();
        if (majorSelect) {
          majorSelect.addEventListener("change", updateSidepanelTitle);
        }
        // also update if options are changed dynamically elsewhere
        // (mutation observer optional)
      })();
    </script>
  </body>
</html>
